# Task 006: 既存のRust MCP ServerにgRPCトランスポート対応を追加

## 概要

既存のrmcpベースのMCPサーバーアーキテクチャにgRPCサーバー機能を統合します。これには、gRPCサービスコールを既存のUnity MCPハンドラーにブリッジすること、サーバーがstdioとgRPCの両方のトランスポートを同時に処理できるようにすること、適切なリクエストルーティングとレスポンス処理を確保することが含まれます。

## 受入基準

- [ ] gRPCサービスを既存のUnity MCPハンドラーと統合する
- [ ] デュアルトランスポート対応を有効化する（stdio + gRPC）
- [ ] gRPCコールをrmcpツールハンドラーにルーティングする
- [ ] gRPCメッセージとrmcp型間の変換を行う
- [ ] 既存のMCPプロトコル準拠を維持する
- [ ] main.rsにgRPCサーバー設定を追加する
- [ ] 両方のトランスポートが独立して動作することを確認する
- [ ] gRPCインターフェース経由でMCP操作をテストする
- [ ] stdioトランスポート機能の回帰がないことを確認する

## 実装ノート

**統合アーキテクチャ:**
```rust
// 既存: stdioトランスポート -> Unityハンドラー -> ツール
// 新規: gRPCトランスポート -> gRPCサービス -> Unityハンドラー -> ツール

pub struct UnityGrpcService {
    unity_handler: Unity,  // 既存のMCPハンドラーを再利用
}

impl UnityMcpService for UnityGrpcService {
    async fn list_tools(&self, request: Request<ListToolsRequest>) 
        -> Result<Response<ListToolsResponse>, Status> {
        // gRPCリクエストをrmcp形式に変換
        // unity_handlerメソッドを呼び出し
        // rmcpレスポンスをgRPC形式に変換
    }
}
```

**技術的考慮事項:**
- protobufとrmcp型間のメッセージ変換
- エラーハンドリングとステータスコードマッピング
- Tonicとrmcp間の非同期パターン互換性
- サーバーバインディング（ポート、アドレス）の設定
- 両方のトランスポートの優雅なシャットダウン処理
- トランスポート間でのリソース共有

**トランスポート設定:**
- 設定可能なポートでgRPCサーバーを実行（デフォルト: 50051）
- 後方互換性のためstdioトランスポートを維持
- 並行トランスポート処理にtokioを使用
- トランスポート選択設定を追加

## 変更・作成対象ファイル

- `server/src/grpc/service.rs` - Unityハンドラーとの統合
- `server/src/grpc/conversion.rs` - メッセージ型変換
- `server/src/main.rs` - マルチトランスポートサーバーセットアップ
- `server/config/default.toml` - gRPCサーバー設定
- 共有使用のため既存のUnity構造体を更新

## テスト要件

- stdioとgRPCの両方のトランスポートが同時に動作する
- MCP操作がトランスポート間で同一の結果を生成する
- トランスポート間でデータ競合状態が発生しない
- rmcpからgRPCへの適切なエラー伝播
- 設定変更がgRPCサーバーの動作に影響する
- 両方のトランスポートで優雅なシャットダウンが動作する
- リソースクリーンアップによりメモリリークを防ぐ
- トランスポート間で同等のパフォーマンス

## 依存関係

- **必要条件:** Task 001 (Protocol Buffersサービス定義)
- **必要条件:** Task 002 (Rust gRPCサーバー依存関係) 
- **必要条件:** Task 003 (Rust gRPCサーバースタブ)

## ブロック対象

- Task 007: 双方向ストリーミングの実装
- Task 009: 統合テストの作成

## 実装優先度

**高優先度** - gRPC経由でのMCP操作有効化に必要不可欠。

## 技術的課題

**メッセージ変換:**
- rmcpツール定義をprotobufメッセージにマッピング
- オプションフィールドとネストした構造の処理
- 変換間でのエラー情報保持
- 変換中の型安全性維持

**並行性の考慮事項:**
- Unityハンドラーへのスレッドセーフアクセス
- トランスポート間でのリソース競合
- 非同期ランタイム互換性
- 複数クライアントの接続管理

## 統合ポイント

**既存コードとの統合:**
- Unity構造体とtool_routerの再利用
- 既存のエラーハンドリングパターンの活用
- トレーシングとログ出力の一貫性維持
- 設定管理アプローチの保持