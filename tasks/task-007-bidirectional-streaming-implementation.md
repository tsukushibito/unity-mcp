# Task 007: MCP操作のための双方向ストリーミング実装

## 概要

Rust MCP サーバーと Unity Editor ブリッジ間のリアルタイム通信のための双方向ストリーミングサポートを実装します。これには、サーバー主導のイベント（通知、進捗更新）とクライアント主導のストリーミングリクエストが含まれ、Unity Editor 統合のための効率的なリアルタイムデータ交換を可能にします。

## 受入基準

- [ ] プロトコルバッファで双方向ストリーミングRPCメソッドを実装する
- [ ] Rustでサーバーサイドストリーミング実装を追加する
- [ ] Unity C# クライアントでクライアントサイドストリーミングハンドリングを追加する
- [ ] イベント通知システム（サーバー -> Unity）を作成する
- [ ] 長時間実行処理の進捗追跡を実装する
- [ ] ストリームライフサイクル管理とエラーハンドリングを追加する
- [ ] サーバーとUnity間のリアルタイム通信をテストする
- [ ] ストリームの回復性と再接続処理を検証する
- [ ] ストリーミングリソースの適切なクリーンアップを保証する

## 実装メモ

**ストリーミングアーキテクチャ:**
```proto
service UnityMcpService {
  // リアルタイム通信のための双方向ストリーミング
  rpc StreamEvents(stream ClientMessage) returns (stream ServerMessage);
  
  // 進捗更新のためのサーバーストリーミング
  rpc ExecuteWithProgress(ExecuteRequest) returns (stream ProgressUpdate);
}
```

**メッセージタイプ:**
```proto
message ClientMessage {
  oneof message {
    SubscribeRequest subscribe = 1;
    UnsubscribeRequest unsubscribe = 2;
    KeepAliveRequest keep_alive = 3;
  }
}

message ServerMessage {
  oneof message {
    EventNotification event = 1;
    ProgressUpdate progress = 2;
    KeepAliveResponse keep_alive = 3;
  }
}
```

**ユースケース:**
- Unity Editor イベント（プロジェクト変更、アセット修正）
- 長時間実行ツールの実行進捗
- リアルタイム協調機能
- システムステータス更新
- エラー通知と警告

**技術的考慮事項:**
- 異なるイベントタイプのためのストリーム多重化
- 高頻度イベントのための背圧ハンドリング
- ストリームヘルスモニタリングとハートビート
- 優雅なストリーム終了とクリーンアップ
- エラー復旧と再接続ロジック

## 作成・修正するファイル

- `proto/unity_mcp.proto` - ストリーミングRPC定義を追加
- `server/src/grpc/streaming.rs` - サーバーサイドストリーミング実装
- `server/src/grpc/events.rs` - イベント通知システム
- `bridge/Runtime/Streaming/McpStreamingClient.cs` - クライアントストリーミングハンドラー
- `bridge/Runtime/Events/` - イベントハンドリングとサブスクリプションシステム

## テスト要件

- 双方向ストリームが正常に確立される
- 複数の同時ストリームが正しく動作する
- イベントサブスクリプションと通知が機能する
- 長時間実行処理中に進捗更新が適切にストリーミングされる
- ストリーム中断と復旧が正しく動作する
- 閉じられていないストリームによるメモリリークがない
- 高頻度イベントがパフォーマンス問題を引き起こさない
- クライアント再接続でストリームサブスクリプションが復元される

## 依存関係

- **要求:** Task 001 (Protocol Buffers サービス定義)
- **要求:** Task 003 (Rust gRPC サーバースタブ)
- **要求:** Task 005 (Unity gRPC クライアントラッパー)
- **要求:** Task 006 (Rust gRPC トランスポート統合)

## ブロック対象

- Task 009: 統合テストの作成
- Task 010: エラーハンドリングと再接続ロジックの追加

## 実装優先度

**中程度の優先度** - リアルタイム機能を強化するが、基本的なMCP操作には必須ではない。

## ストリーミングパターン

**サーバーからクライアントへのイベント:**
- Unity プロジェクトファイル変更
- アセットインポート/エクスポート進捗
- ビルドシステム通知
- エラーと警告のブロードキャスト

**クライアントからサーバーへのイベント:**
- エディターアクション追跡
- ユーザーインタラクションイベント
- 設定変更
- ヘルスチェックping

**双方向パターン:**
- ストリーミング進捗付きリクエスト-レスポンス
- イベントサブスクリプション管理
- リアルタイム協調編集
- デバッグセッション通信

## パフォーマンス考慮事項

**効率性:**
- 高頻度イベントのためのメッセージバッチ処理
- サブスクリプションベースの選択的イベントフィルタリング
- ストリーミングメッセージの効率的なシリアライゼーション
- 複数ストリームタイプのためのコネクションプーリング

**リソース管理:**
- ストリーム接続制限
- バッファされたストリームのメモリ使用量監視
- メッセージ処理のためのCPU使用量最適化
- ネットワーク帯域幅管理