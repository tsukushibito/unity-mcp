# Task 009: Rust-Unity gRPC通信の統合テスト作成

## 概要

Rust MCPサーバーとUnity Editorブリッジ間のgRPCを介したエンドツーエンド通信を検証する包括的な統合テストを開発する。これにはすべてのMCPオペレーション、エラーシナリオ、ストリーミング機能、およびgRPCトランスポート層全体のパフォーマンス特性のテストが含まれる。

## 受け入れ基準

- [ ] gRPCサーバー機能のRust統合テストを作成
- [ ] gRPCクライアント機能のUnity統合テストを作成
- [ ] gRPCを通じたすべてのMCPオペレーション（ツール、リソース、プロンプト）をテスト
- [ ] Unity固有のオペレーションと通信をテスト
- [ ] エラーハンドリングとエッジケースを検証
- [ ] ストリーミング機能とリアルタイム通信をテスト
- [ ] gRPCトランスポートのパフォーマンスと負荷テスト
- [ ] クロスプラットフォーム互換性テスト
- [ ] 統合テストの自動CI統合

## 実装ノート

**テスト構造:**
```
server/tests/integration/
├── grpc_server_tests.rs      # 基本的なgRPCサーバーテスト
├── mcp_operations_tests.rs   # MCPプロトコル準拠テスト
├── streaming_tests.rs        # 双方向ストリーミングテスト
├── error_handling_tests.rs   # エラーシナリオテスト
└── performance_tests.rs      # 負荷・パフォーマンステスト

bridge/Tests/Runtime/
├── GrpcClientTests.cs        # Unityクライアント機能テスト
├── McpIntegrationTests.cs    # エンドツーエンドMCPオペレーションテスト
├── StreamingTests.cs         # リアルタイム通信テスト
└── ErrorHandlingTests.cs     # エラーシナリオテスト
```

**テストカテゴリ:**

1. **基本接続テスト:**
   - サーバーの起動と終了
   - クライアント接続の確立
   - 認証と認可
   - ネットワークエラーハンドリング

2. **MCPプロトコルテスト:**
   - ツール一覧取得オペレーション
   - 各種パラメータでのツール呼び出し
   - リソース一覧取得オペレーション
   - リソース取得
   - プロンプトオペレーション

3. **Unity固有テスト:**
   - プロジェクト情報取得
   - アセットオペレーション
   - シーン管理
   - エディター状態同期

4. **ストリーミングテスト:**
   - 双方向ストリーム確立
   - イベント通知配信
   - 進捗更新ストリーミング
   - ストリームエラー復旧

5. **パフォーマンステスト:**
   - 同時クライアント接続
   - 高頻度メッセージスループット
   - 負荷時のメモリ使用量
   - レスポンス時間ベンチマーク

**技術的考慮事項:**
- テストの分離とクリーンアップ
- ユニットテスト用のモックサーバー/クライアント実装
- テストデータ管理とフィクスチャ
- 非同期テストパターンとタイムアウト
- クロスプラットフォームテスト実行

## 作成するファイル

**Rustテスト:**
- `server/tests/integration/grpc_server_tests.rs`
- `server/tests/integration/mcp_operations_tests.rs`
- `server/tests/integration/streaming_tests.rs`
- `server/tests/integration/common/mod.rs` - テストユーティリティ
- `server/tests/fixtures/` - テストデータと設定

**Unityテスト:**
- `bridge/Tests/Runtime/GrpcClientTests.cs`
- `bridge/Tests/Runtime/McpIntegrationTests.cs`
- `bridge/Tests/Runtime/StreamingTests.cs`
- `bridge/Tests/Editor/EditorIntegrationTests.cs`
- `bridge/Tests/TestUtilities/` - 共有テストユーティリティ

**CI設定:**
- 統合テスト用の`.github/workflows/ci.yml`更新
- テスト環境セットアップ用Docker compose
- テスト結果レポートとアーティファクト収集

## テスト要件

- すべてのテストがクリーンな環境で成功
- テストが決定論的かつ再実行可能
- 適切なクリーンアップによりテスト間の干渉を防止
- 包括的なエラーシナリオカバレッジ
- パフォーマンスベンチマークによるベースライン確立
- CI環境でのテスト正常実行
- クロスプラットフォーム互換性の検証
- メモリリークの検出と防止

## 依存関係

- **必須:** Task 003 (Rust gRPCサーバースタブ)
- **必須:** Task 005 (Unity gRPCクライアントラッパー)
- **必須:** Task 006 (Rust gRPCトランスポート統合)
- **推奨:** Task 007 (双方向ストリーミング)
- **推奨:** Task 008 (設定管理)

## ブロック

このタスクは他のすべての実装を検証するが、さらなる開発をブロックしない。

## 実装優先度

**高優先度** - 信頼性の高いgRPC通信の確保とリグレッション防止に不可欠。

## テストインフラストラクチャ

**テスト環境セットアップ:**
- テスト用の自動サーバー起動/終了
- テスト設定の分離
- 並列テスト用のネットワークポート管理
- テストデータの投入とクリーンアップ

**モック・スタブ:**
- テスト用のモックUnity Editor環境
- 外部依存関係のスタブ
- 各種シナリオ用の設定可能なテストダブル
- テスト固有のプロトコル実装

**パフォーマンステスト:**
- 複数同時クライアントでの負荷テスト
- 異なるメッセージサイズでのスループット測定
- 様々な条件下でのレイテンシベンチマーク
- テスト中のリソース使用量監視

## CI統合

**自動テスト:**
- プルリクエストでの統合テスト実行
- パフォーマンス回帰検出
- クロスプラットフォームテスト実行
- テスト結果レポートと可視化

**環境管理:**
- 一貫したテスト環境のためのDockerコンテナ
- テストデータベースと設定管理
- 失敗したテストのアーティファクト収集
- テストカバレッジレポート

## テストデータ管理

**フィクスチャとテストデータ:**
- 代表的なMCPツール定義
- サンプルUnityプロジェクト構造
- 様々なメッセージサイズシナリオ
- エラー条件の再現
- パフォーマンステスト用データセット