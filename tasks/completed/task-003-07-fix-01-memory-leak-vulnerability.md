# Task 3.7 Fix 01: メモリリーク脆弱性修正

## 概要
Task 3.7のストリーミングサービス実装で特定された重大なメモリリーク脆弱性を修正します。unbounded_channelの使用により、悪意のあるクライアントがDoS攻撃を実行可能な状態を解決します。

## 優先度
**🔴 最高優先度** - セキュリティ脆弱性のため即座の修正が必要

## 実装時間見積もり
**1-2時間** - 集中作業時間

## 受け入れ基準

### 機能要件
- [ ] `tokio::sync::mpsc::unbounded_channel()` を `bounded_channel` に変更
- [ ] 適切なチャネル容量制限を設定（推奨値: 1000-2000メッセージ）
- [ ] バックプレッシャー処理の実装
- [ ] チャネル満杯時の適切なエラーハンドリング

### セキュリティ要件
- [ ] メモリ使用量の上限設定
- [ ] DoS攻撃に対する脆弱性の排除
- [ ] リソース制限の適切な実装

### 品質要件
- [ ] 既存機能の動作保証
- [ ] ログレベルの適切な設定
- [ ] パフォーマンスへの悪影響なし

## 技術的詳細

### 修正対象コード
**ファイル**: `server/src/grpc/service.rs`  
**場所**: Line 520  
**現在のコード**:
```rust
let (tx, rx) = tokio::sync::mpsc::unbounded_channel();
```

### 修正後コード
```rust
// セキュアなバウンデッドチャネルの実装
const STREAM_CHANNEL_CAPACITY: usize = 1000;

let (tx, rx) = tokio::sync::mpsc::channel(STREAM_CHANNEL_CAPACITY);
```

### バックプレッシャー処理
```rust
// メッセージ送信時のバックプレッシャー処理
match tx.try_send(Ok(response)) {
    Ok(_) => {
        // 送信成功
        debug!("Stream response sent successfully");
    }
    Err(tokio::sync::mpsc::error::TrySendError::Full(_)) => {
        warn!("Stream channel is full, applying backpressure");
        // 適切なバックプレッシャー処理
        if let Err(_) = tx.send(create_backpressure_error()).await {
            warn!("Failed to send backpressure error - breaking stream");
            break;
        }
    }
    Err(tokio::sync::mpsc::error::TrySendError::Closed(_)) => {
        warn!("Stream channel closed - terminating stream handler");
        break;
    }
}
```

### エラーハンドリング改善
```rust
fn create_backpressure_error() -> Result<StreamResponse, Status> {
    Ok(StreamResponse {
        message: Some(stream_response::Message::ImportAsset(
            ImportAssetResponse {
                asset: None,
                error: Some(McpError {
                    code: 8, // RESOURCE_EXHAUSTED
                    message: "Stream processing capacity exceeded".to_string(),
                    details: "Please reduce message rate".to_string(),
                }),
            },
        )),
    })
}
```

## 実装計画

### Step 1: 設定定数の追加
```rust
impl UnityMcpServiceImpl {
    // 既存の定数に追加
    const STREAM_CHANNEL_CAPACITY: usize = 1000;
    const STREAM_BACKPRESSURE_THRESHOLD: f64 = 0.8; // 80%で警告
}
```

### Step 2: チャネル初期化の変更
- unbounded_channel → channel への変更
- 適切な容量設定

### Step 3: バックプレッシャー処理の実装
- try_send を使用したノンブロッキング送信
- チャネル満杯時の適切な処理
- クライアントへの通知機能

### Step 4: 監視とログの追加
- チャネル使用量の監視
- バックプレッシャー発生時のログ
- メトリクス収集の準備

## テスト方針

### ユニットテスト
```rust
#[tokio::test]
async fn test_bounded_channel_backpressure() {
    // チャネル容量超過時の動作確認
}

#[tokio::test]
async fn test_stream_channel_capacity_limit() {
    // 容量制限の動作確認
}
```

### 統合テスト
- 高負荷環境での動作確認
- メモリ使用量の測定
- レスポンス時間への影響評価

## 検証方法

### セキュリティ検証
1. **DoS攻撃シミュレーション**
   - 大量メッセージ送信テスト
   - メモリ使用量監視
   - システム安定性確認

2. **リソース制限確認**
   - メモリリーク検出ツール実行
   - 長時間運用テスト
   - ガベージコレクション動作確認

### 機能回帰テスト
- 既存ストリーミング機能の動作確認
- 各メッセージタイプの処理確認
- エラーケースの動作確認

## 依存関係

### 前提条件
- Task 3.7の完了（既存実装の理解）
- 現在の実装の動作確認

### ブロック対象
- Task 3.7 Fix 02 (リソース管理改善)
- Task 3.7 Fix 03 (エラーハンドリング改善)

## リスク評価

### 高リスク
- **機能回帰**: バックプレッシャー実装による機能影響
- **パフォーマンス**: チャネル容量制限による処理速度低下

### 中リスク
- **設定値**: 適切なチャネル容量の決定
- **互換性**: 既存クライアントへの影響

### 低リスク
- **実装複雑度**: 比較的単純な修正
- **テスト**: 明確な検証方法

## 緩和策

### 機能回帰対策
- 段階的なロールアウト
- A/Bテストの実施
- ロールバック計画の準備

### パフォーマンス対策
- 適切な容量値のチューニング
- 監視メトリクスの実装
- 動的調整機能の検討

## 実装後の検証項目

### 即座の確認
- [ ] コンパイルエラーなし
- [ ] 基本的なストリーミング動作確認
- [ ] メモリ使用量の正常化

### 詳細検証
- [ ] 高負荷テストの実行
- [ ] セキュリティスキャンの実行
- [ ] パフォーマンス回帰テスト

## 成功基準

### 定量的基準
- メモリ使用量上限: 設定容量 × メッセージ平均サイズ
- DoS耐性: 連続100,000メッセージ送信でもシステム安定
- パフォーマンス: 既存処理速度の95%以上維持

### 定性的基準
- セキュリティ脆弱性の完全排除
- システムの安定性向上
- 運用監視の改善

## 次のステップ

修正完了後:
1. コードレビューの実施
2. セキュリティ検証の実行
3. Task 3.7 Fix 02への移行

## 関連ドキュメント
- `reviews/task-3-7-streaming-service-review.md`
- `server/src/grpc/service.rs` (Line 520)
- Tokio mpsc documentation